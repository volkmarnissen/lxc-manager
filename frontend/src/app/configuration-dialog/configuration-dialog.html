<div class="dialog" [class.ssh-dialog]="sshMode">
	@if (sshMode) {
		<div class="header">
			<h3>SSH Configuration</h3>
			<button type="button" mat-stroked-button color="primary" (click)="addSsh()">‚ûï Add SSH</button>
		</div>
		<form #sshForm="ngForm" (ngSubmit)="save()">
			@if (ssh.length > 0) {
						@for (s of ssh; track s; let idx = $index) {
							<div class="form-row">
								<mat-radio-button [checked]="s.current" (change)="setCurrent(idx)" aria-label="Set current"></mat-radio-button>
								<mat-form-field appearance="fill" class="field">
									<input matInput [(ngModel)]="s.host" [name]="'host' + idx" placeholder="Host" readonly disabled />
								</mat-form-field>
								<mat-form-field appearance="fill" class="field narrow">
									<input matInput type="number" [(ngModel)]="s.port" [name]="'port' + idx" placeholder="Port" readonly disabled />
								</mat-form-field>
								@if (ssh.length > 1) {
									<button type="button" mat-icon-button color="warn" (click)="removeSsh(idx)" aria-label="Remove">
										üóëÔ∏è
									</button>
								}
							</div>
						}
			}
			<!-- Add button moved to header -->
			@if (permissionOk) {
				<div class="ok-banner"><mat-icon class="ok-icon">verified</mat-icon> SSH access is working. No further action required.</div>
			}
						@else {
								<div class="warn-banner"><mat-icon class="warn-icon">warning</mat-icon> SSH access is not allowed yet. Please run the steps below.</div>
								@if (ssh.length > 0) {
									<div class="stderr-box">
										<div class="stderr-title">SSH Fehlerdetails</div>
										<pre class="stderr-content">{{ getCurrentStderr() }}</pre>
									</div>
								}
						}
			<mat-accordion multi>
				@if (publicKeyCommand) {
					<mat-expansion-panel>
						<mat-expansion-panel-header>
							Add the service public key (run first)
							@if (permissionOk) { <span class="panel-ok"><mat-icon class="ok-icon">check_circle</mat-icon></span> }
						</mat-expansion-panel-header>
						<div class="help">
							Run this on the Proxmox host as <strong>root</strong>.
							It appends the public key to <code>~/.ssh/authenticated_keys</code>, which is used by the SSH drop‚Äëin.
							It is safe to run this command multiple times.
						</div>
						<div class="command-row">
							<mat-form-field appearance="fill" class="full-width">
								<textarea matInput [value]="publicKeyCommand" readonly rows="3"></textarea>
							</mat-form-field>
							<button mat-icon-button type="button" class="copy-btn" (click)="copy(publicKeyCommand)" aria-label="Copy public key command">
								<mat-icon>content_copy</mat-icon>
							</button>
						</div>
					</mat-expansion-panel>
				}
				@if (installSshServer) {
					<mat-expansion-panel>
						<mat-expansion-panel-header>
							Install and harden SSH server (one‚Äëtime)
							@if (permissionOk) { <span class="panel-ok"><mat-icon class="ok-icon">check_circle</mat-icon></span> }
						</mat-expansion-panel-header>
						<div class="help">
							Run on the Proxmox host as <strong>root</strong>, after the public key is present.<br />
							This installs <code>openssh-server</code> (if needed), writes a drop‚Äëin at <code>/etc/ssh/sshd_config.d/lxc-manager.conf</code>,
							enables public key authentication and disables password authentication, then restarts SSH.<br />
							Tip: Ensure you have console access in case you need to revert settings.
						</div>
						<div class="command-row">
							<mat-form-field appearance="fill" class="full-width">
								<textarea matInput [value]="installSshServer" readonly rows="4"></textarea>
							</mat-form-field>
							<button mat-icon-button type="button" class="copy-btn" (click)="copy(installSshServer)" aria-label="Copy install command">
								<mat-icon>content_copy</mat-icon>
							</button>
						</div>
						<div class="help">
							Verify: <code>systemctl status ssh</code> and <code>tail -n1 ~/.ssh/authenticated_keys</code> on the Proxmox host.
						</div>
					</mat-expansion-panel>
				}
			</mat-accordion>

			<div class="dialog-actions">
				<button type="submit" [disabled]="!canSave || !sshForm.form.valid">Save</button>
				<button type="button" (click)="cancel()">Cancel</button>
			</div>

			@if (error) {
				<div class="error">{{ error }}</div>
			}
		</form>
	}
</div>
