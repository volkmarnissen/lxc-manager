<div class="ssh-config-page">
  

  <div class="dialog ssh-dialog">
    <div class="page-header">
    <h2>SSH Configuration</h2>
  </div>
    <form #sshForm="ngForm">
      @if (ssh.length > 0) {
        @for (s of ssh; track s; let idx = $index) {
          <div class="grid-row">
            <div class="col radio">
              <mat-radio-button [checked]="s.current" (change)="setCurrent(idx)" aria-label="Set current"></mat-radio-button>
            </div>
            <div class="col host">
              <mat-form-field appearance="fill" class="field">
                <input matInput [(ngModel)]="s.host" [name]="'host' + idx" placeholder="Host" readonly disabled />
              </mat-form-field>
            </div>
            <div class="col port">
              <mat-form-field appearance="fill" class="field">
                <input matInput type="number" [(ngModel)]="s.port" [name]="'port' + idx" placeholder="Port" readonly disabled />
              </mat-form-field>
            </div>
            <div class="col actions">
              <button type="button" mat-icon-button color="warn" (click)="removeSsh(idx)" aria-label="Remove">üóëÔ∏è</button>
            </div>
          </div>
        }
      }

      <!-- Add row as part of the list (unchecked) -->
      <div class="grid-row add-row">
        <div class="col radio">
          <mat-radio-button [checked]="false" disabled aria-label="Set current (new)"></mat-radio-button>
        </div>
        <div class="col host">
          <mat-form-field appearance="fill" class="field">
            <input matInput [(ngModel)]="newHost" name="newHost" placeholder="Host" />
          </mat-form-field>
        </div>
        <div class="col port">
          <mat-form-field appearance="fill" class="field">
            <input matInput type="number" [(ngModel)]="newPort" name="newPort" placeholder="Port" />
          </mat-form-field>
        </div>
        <div class="col actions">
          <button type="button" mat-icon-button color="primary" (click)="addSsh()" aria-label="Add SSH">‚ûï</button>
        </div>
      </div>

      @if (permissionOk) {
        <div class="ok-banner"><mat-icon class="ok-icon">verified</mat-icon> SSH access is working. No further action required.</div>
      }
      @else {
        <div class="warn-banner emphasized"><mat-icon class="warn-icon">warning</mat-icon> SSH access is not allowed yet. Please run the steps below.</div>
        @if (ssh.length > 0) {
          <div class="stderr-box">
            <div class="stderr-title">SSH Error Details</div>
            <pre class="stderr-content">{{ getCurrentStderr() }}</pre>
          </div>
        }
        <mat-accordion multi>
        @if (publicKeyCommand) {
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              Add the service public key (run first)
              @if (permissionOk) { <span class="panel-ok"><mat-icon class="ok-icon">check_circle</mat-icon></span> }
            </mat-expansion-panel-header>
            <div class="help">
              Run this on the Proxmox host as <strong>root</strong>.
              It appends the public key to <code>~/.ssh/authenticated_keys</code>, which is used by the SSH drop‚Äëin.
              It is safe to run this command multiple times.
            </div>
            <div class="command-row">
              <mat-form-field appearance="fill" class="full-width">
                <textarea matInput [value]="publicKeyCommand" readonly rows="3"></textarea>
              </mat-form-field>
              <button mat-icon-button type="button" class="copy-btn" (click)="copy(publicKeyCommand)" aria-label="Copy public key command">
                <mat-icon>content_copy</mat-icon>
              </button>
            </div>
          </mat-expansion-panel>
        }
        @if (installSshServer) {
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              Install and harden SSH server (one‚Äëtime)
              @if (permissionOk) { <span class="panel-ok"><mat-icon class="ok-icon">check_circle</mat-icon></span> }
            </mat-expansion-panel-header>
            <div class="help">
              Run on the Proxmox host as <strong>root</strong>, after the public key is present.<br />
              This installs <code>openssh-server</code> (if needed), writes a drop‚Äëin at <code>/etc/ssh/sshd_config.d/lxc-manager.conf</code>,
              enables public key authentication and disables password authentication, then restarts SSH.<br />
              Tip: Ensure you have console access in case you need to revert settings.
            </div>
            <div class="command-row">
              <mat-form-field appearance="fill" class="full-width">
                <textarea matInput [value]="installSshServer" readonly rows="4"></textarea>
              </mat-form-field>
              <button mat-icon-button type="button" class="copy-btn" (click)="copy(installSshServer)" aria-label="Copy install command">
                <mat-icon>content_copy</mat-icon>
              </button>
            </div>
            <div class="help">
              Verify: <code>systemctl status ssh</code> and <code>tail -n1 ~/.ssh/authenticated_keys</code> on the Proxmox host.
            </div>
          </mat-expansion-panel>
        }
        </mat-accordion>

      }


      @if (error) { <div class="error">{{ error }}</div> }
    </form>
  </div>
</div>
