name: Build APK Package and Release Assets

on:
  workflow_call:
    inputs:
      version:
        description: 'Version (without leading v). If omitted, read from package.json.'
        required: false
        type: string
    outputs:
      resolved_version:
        description: 'Resolved version used for tagging.'
        value: ${{ jobs.prepare.outputs.resolved_version }}
      image_tag:
        description: 'Docker image tag (v<version>).'
        value: ${{ jobs.docker.outputs.image_tag }}
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (without leading v). If omitted, read from package.json.'
        required: false
        type: string
env:
  product_name: lxc-manager
  main_docker_name: 'ghcr.io/${{ github.repository_owner }}/lxc-manager'
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      resolved_version: ${{ steps.setver.outputs.resolved_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Read version
        id: setver
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "resolved_version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            PKG_VERSION=$(python3 -c "import json;print(json.load(open('package.json'))['version'])")
            echo "resolved_version=$PKG_VERSION" >> $GITHUB_OUTPUT
          fi
          echo "Using version: $(cat $GITHUB_OUTPUT)"

  build_apk:
    runs-on: ubuntu-latest
    environment: packager
    needs: prepare
    permissions:
      packages: write      
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bash
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          registry-url: 'https://registry.npmjs.org'
          always-auth: true
      - name: Build APK
        env:
          PACKAGER_PRIVKEY: ${{ secrets.PACKAGER_PRIVKEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euxo pipefail
          echo "Building APK on native runner (platform-independent)..."

          # Ensure generator script is executable
          chmod +x alpine/build.sh || true

          # Build APKs using the unified generator script
          alpine/build.sh
          echo "âœ“ APK build completed"

          # Verify APK creation
          echo "Verifying APK creation..."
          REPO_DIR="alpine/package/repo"
          if [ -d "$REPO_DIR" ]; then
            echo "âœ“ Repo directory exists: $REPO_DIR"
            ls -la "$REPO_DIR" || true
            apk_count=$(find "$REPO_DIR" -name "*.apk" | wc -l)
            echo "Found $apk_count APK files"
          else
            echo "ERROR: Repo directory $REPO_DIR not found!"
            echo "Available directories:";
            ls -la alpine/package/repo/ || true
            exit 1
          fi

      - name: Debug APK structure before upload
        run: |
          echo "Checking APK structure..."
          ls -laR alpine/package/repo/ || echo "alpine/package/repo not found"
          find . -name "*.apk" -type f || echo "No APK files found"

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apks-${{ needs.prepare.outputs.resolved_version }}
          path: alpine/package/repo/*.apk
          if-no-files-found: error

      - name: Upload packager.rsa.pub as separate artifact
        uses: actions/upload-artifact@v4
        with:
          name: packager-rsa-pub-${{ needs.prepare.outputs.resolved_version }}
          path: alpine/package/repo/packager.rsa.pub
          if-no-files-found: error

  # Docker image build removed per request; release is APK-only

  attach_release_assets:
    runs-on: ubuntu-latest
    needs: [prepare, build_apk]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download APK artifacts
        uses: actions/download-artifact@v4
        with:
          name: apks-${{ needs.prepare.outputs.resolved_version }}
          path: apks
      - name: Download packager.rsa.pub artifact
        uses: actions/download-artifact@v4
        with:
          name: packager-rsa-pub-${{ needs.prepare.outputs.resolved_version }}
          path: release-apks/

      - name: Flatten APK artifacts for upload
        run: |
          mkdir -p release-apks
          find apks -type f -name "*.apk" -exec cp {} release-apks/ \;
          # Ensure public key is included as well
          if [ -f release-apks/packager.rsa.pub ]; then :; else cp alpine/package/repo/packager.rsa.pub release-apks/ || true; fi
          ls -lh release-apks/

      - name: Generate GitHub changelog (initial-release-notes.md)
        run: |
          TAG="v${{ needs.prepare.outputs.resolved_version }}"
          API="https://api.github.com/repos/${{ github.repository }}/releases/generate-notes"
          echo "Requesting generated release notes for $TAG"
          RESPONSE=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -X POST -d "{\"tag_name\":\"$TAG\"}" "$API")
          echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get('body',''))" > initial-release-notes.md || true
          if [ ! -s initial-release-notes.md ]; then
            echo "## Changelog" > initial-release-notes.md
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate release body with APK table
        id: release-body
        run: |
          VERSION="${{ needs.prepare.outputs.resolved_version }}"

          # Append GitHub changelog (initial-release-notes.md) at the top
          if [ -f initial-release-notes.md ]; then
            # Add a blank line after the changelog so Markdown headers render correctly
            cat initial-release-notes.md > release-body.md
            echo >> release-body.md
          fi

          # Create release body with APK table
          cat >> release-body.md << EOF
          ## ðŸ“¦ $product_name v${{ needs.prepare.outputs.resolved_version }}

          ### ðŸ“‹ Alpine APK Package

          EOF

          # Add an entry for the generated APK (platform-independent)
          APK_FILE=$(ls release-apks/*.apk 2>/dev/null | head -n1 || true)
          if [ -n "$APK_FILE" ]; then
            FILENAME=$(basename "$APK_FILE")
            SIZE=$(ls -lh "$APK_FILE" | awk '{print $5}')
            DOWNLOAD_LINK="[ðŸ“¥ Download](https://github.com/${{ github.repository }}/releases/download/v${VERSION}/$FILENAME)"
            printf "%s\n" "$product_name APK Size: \`$FILENAME\` $SIZE    $DOWNLOAD_LINK" >> release-body.md
          else
            echo "apknotfound=true" >> $GITHUB_OUTPUT
          fi

          # Add public key section

          cat >> release-body.md << 'EOF'

          ### ðŸ” Package Verification

          **Public Key for APK signature verification:**

          | File | Purpose | Download |
          |------|---------|----------|
          | `packager.rsa.pub` | APK signature verification | [ðŸ“¥ Download](https://github.com/${{ github.repository }}/releases/download/v${{ needs.prepare.outputs.resolved_version }}/packager.rsa.pub) |

          ## Quick Install
          Run this on your Proxmox host **(adjust IP addresses to your network)**:

          ```sh
          curl -fsSL https://raw.githubusercontent.com/modbus2mqtt/lxc-manager/main/install-lxc-manager.sh \
            | sh -s -- --static-ip 192.168.4.100/24 --static-gw 192.168.4.1  # <- adjust IPs
          ```

          - `--static-ip`: IPv4 address in CIDR (e.g., `192.168.4.100/24`)
          - `--static-gw`: IPv4 gateway (e.g., `192.168.4.1`)

          For IPv6 **(adjust IP addresses to your network)**:
          ```sh
          curl -fsSL https://raw.githubusercontent.com/modbus2mqtt/lxc-manager/main/install-lxc-manager.sh \
            | sh -s -- --static-ip6 fd00::50/64 --static-gw6 fd00::1  # <- adjust IPs
          ```
          ---

          ðŸ“š **Documentation:** [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)  
          ðŸ› **Issues:** [Report bugs](https://github.com/${{ github.repository }}/issues)  
          ðŸ’¬ **Discussions:** [Community support](https://github.com/${{ github.repository }}/discussions)
          EOF

          echo "Release body generated successfully"

      - name: Upload to existing Release (if exists)
        if: ${{ steps.release-body.outputs.apknotfound != 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.resolved_version }}
          append_body: false
          body_path: release-body.md
          files: release-apks/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # Hassio update removed per request
# Notes:
# - dry_run=true allows local verification without pushing image or release assets.
# - Multi-arch APK builds (x86_64 + aarch64) use QEMU for cross-compilation.
# - Docker image builds with strict signature verification (no untrusted fallback).
# - This workflow is designed to be called from a publish workflow after version bump.
